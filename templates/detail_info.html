{% extends "layout.html" %}

{% block title %} 平台详情 {% endblock %}

{% block body %}

    <!-- 显示导航栏 -->
    <div class="container" style="margin-top: 70px">


        <div class="row">

            <div class="col-md-6 col-md-offset-1 ">
                <div class="list-group" style="width: 100%;">

                    <a class="list-group-item list-group-item-heading list-group-item-info ">
                        <div class="row ">

                            <div class="col-md-10 ">
                                <img class="img-responsive" src="{{ url_for("static",filename='img/detail.png') }}"
                                     style="width:42px;height:42px;float:left">

                                <span id="platform_name"
                                      style="font-size:32px;float:left;margin-left: 10px;">{{ platform_name }}</span>
                            </div>

                        </div>
                    </a>


                       <a class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp基本信息
                    </a>
                    <a class="list-group-item list-group-item " style="border-bottom: none;border-top: none;">

                        <span class="text-primary">综合排名 :</span>&nbsp;&nbsp;<span id="platform_rank"></span>
                    </a>
                    <a class="list-group-item list-group-item " style="border-bottom: none;border-top: none;">
                        <span class="text-primary">平均收益 :</span>&nbsp;&nbsp;
                        <span id="platform_earn"></span>%
                    </a>
                    <a class="list-group-item list-group-item " style="border-bottom: none;border-top: none;">

                        <span class="text-primary">上线时间 :</span>&nbsp;&nbsp;
                        <span id="platform_time"></span>
                    </a>
                    <a class="list-group-item list-group-item " style="border-bottom: none;border-top: none;">

                        <span class="text-primary">注册资本 :</span>&nbsp;&nbsp;
                        <span id="platform_volume"></span>万
                    </a>
                    <a class="list-group-item list-group-item " style="border-bottom: none;border-top: none;">

                        <span class="text-primary">投资期限 :</span>&nbsp;&nbsp;
                        <span id="platform_borrowing_period"></span>

                    </a>
                    <a class="list-group-item list-group-item " style="border-bottom: none;border-top: none;">

                        <span class="text-primary">所在地区 :</span>&nbsp;&nbsp;
                        <span id="platform_need_return"></span>

                    </a>


                     <a  id ="comment_div_title"class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp用户评价
                    </a>
 <div id="comment_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                     <a id="chart_ll_div_title"  class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp利率信息
                    </a>
 <div id="chart_ll_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                       <a id="chart_cjl_div_title" class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp成交量信息
                    </a>
                <div id="chart_cjl_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                      <a id="chart_dhk_div_title"  class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp待还款
                    </a>
                <div id="chart_dhk_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                     <a id="chart_zjlr_div_title"  class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp资金净流入
                    </a>
                <div id="chart_zjlr_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                           <a id="chart_tzrs_div_title" class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp投资人数
                    </a>
                <div id="chart_tzrs_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                        <a id="chart_jkrs_div_title" class="list-group-item list-group-item-info">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp借款人数
                    </a>
                <div id="chart_jkrs_div" style="width:100%;height:350px;margin: 0 auto;border:1px solid lightgrey"></div>


                </div>







            </div>

            <div class="col-md-4 ">

<div id="yq_div" >

                    <a class="list-group-item list-group-item-warning list-group-item-heading">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp舆情关键词
                    </a>

                 <div id="yq_keyword"
                     style="width:100%;height:290px;border: none">
                </div>
    </div>




                  <!--div id="" class="list-group">
                    <a class="list-group-item list-group-item-warning">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp评论关键词
                    </a>
                </div>
                 <div id="pl_keyword"
                     style="width:100%;height:300px;">
                </div-->

                  <div id="comments_div" class="list-group">
                    <a class="list-group-item list-group-item-danger list-group-item-heading">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp最新点评
                    </a>

                </div>

                <div id="recent_news_div" class="list-group">
                    <a class="list-group-item list-group-item-success  list-group-item-heading">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp最新资讯
                    </a>
                </div>

                  <div id="related_news_div" class="list-group">
                    <a class="list-group-item list-group-item-info  list-group-item-heading">
                        <span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp相关资讯
                    </a>
                </div>



            </div>

        </div>

        <script>
            // 加载数据
            $(document).ready(function () {
                var platform_name = $("#platform_name").text();
                // 显示
                $.getJSON("/detail/platform/" + platform_name + "/info", function (data) {

                    $('#platform_rank').text(data['rank']);
                    $('#platform_earn').text(data['platEarnings']);
                    $('#platform_volume').text(data['registeredCapital']);
                    $('#platform_borrowing_period').text(data['term']);
                    $('#platform_time').text(data['onlineDate']);
                    $('#platform_need_return').text(data['locationAreaName'] + data['locationCityName']);

                    var frequent_label = data['frequent_label']
                    if (frequent_label.length > 0) {
                        show_frequent_label(platform_name, frequent_label)
                           // show_hot_word(frequent_label,'pl_keyword')
                    } else {
                         $('#comment_div_title').hide();
                        $('#comment_div').hide();
                    }


                    var comments_data_list = data['comments_data_list']
                    if (comments_data_list.length > 0) {
                        show_comments_data_list(comments_data_list)
                    } else {
                        $('#comments_div').hide();
                    }

                    if (data['chart_json']['0'] == null) {
                        $("#chart_ll_div").hide();
                        $("#chart_cjl_div").hide();
                        $("#chart_dhk_div").hide();
                        $("#chart_zjlr_div").hide();
                        $("#chart_tzrs_div").hide();
                        $("#chart_jkrs_div").hide();

                         $("#chart_ll_div_title").hide();
                        $("#chart_cjl_div_title").hide();
                        $("#chart_dhk_div_title").hide();
                        $("#chart_zjlr_div_title").hide();
                        $("#chart_tzrs_div_title").hide();
                        $("#chart_jkrs_div_title").hide();

                    } else {

                        show_chart('chart_ll_div', '利率信息', data['chart_json']['0']['x'], data['chart_json']['0']['y1'], '百分比(%)');
                        show_chart('chart_cjl_div', '成交量信息', data['chart_json']['0']['x'], data['chart_json']['0']['y2'], '成交量(万)');
                        show_chart('chart_dhk_div', '待还款信息', data['chart_json']['1']['x'], data['chart_json']['1']['y1'], '代还款(万)');
                        show_chart('chart_zjlr_div', '资金净流入', data['chart_json']['1']['x'], data['chart_json']['1']['y2'], '净流入资金(万)');
                        show_chart('chart_tzrs_div', '投资人数', data['chart_json']['2']['x'], data['chart_json']['2']['y1'], '投资人数(人)');
                        show_chart('chart_jkrs_div', '借款人数', data['chart_json']['2']['x'], data['chart_json']['2']['y2'], '借款人数(人)');
                    }

                    // 显示新闻
                    var recent_news_list = data['recent_news_list'];
                    var related_news_list = data['related_news_list'];

                        for (var i = 0; i < recent_news_list.length; ++i) {
                            $('#recent_news_div').append(
                                    "<a href='" + recent_news_list[i].url + "' target='_blank' class='list-group-item' style='white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'>" +
                                  recent_news_list[i].title +
                                    "</a>"
                            );
                        }
                        if(recent_news_list.length==0) {
                            $('#recent_news_div').hide();
                        }

                        for (var i = 0; i < related_news_list.length; ++i) {
                            $('#related_news_div').append(
                                    "<a href='" + related_news_list[i].url + "' target='_blank' class='list-group-item' style='white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'>"
                                    + related_news_list[i].title + "</div>" +
                                    "</a>"
                            );
                        }


                      if(related_news_list.length==0) {
                          $('#related_news_div').hide();
                      }

                    // 显示热点词云
                    if(data.keyword.length==0){
                         $('#yq_div').hide();
                    }else{
                      show_hot_word(data.keyword,'yq_keyword')
                    }


                });


                function createRandomItemStyle() {
                    var base = 240;
                    return {
                        normal: {
                            color: 'rgb(' + [
                                Math.round(Math.random() * base),
                                Math.round(Math.random() * base),
                                Math.round(Math.random() * base)
                            ].join(',') + ')'
                        }
                    };
                }

            // 显示热点词汇
            function show_hot_word(word_data,div_id) {
                var size = 50;
                var show_data = [];
                for (var i = 0; i < word_data.length; ++i) {
                    var word = word_data[i];
                    if (size > 40)
                        size -= 4;
                    else if (size > 24)
                        size -= 2;
                    else if (size > 8)
                        size -= 1;

                    var item = {};
                    item['name'] = word['name'];
                    item['value'] = size;
                    item['itemStyle'] = createRandomItemStyle();
                    show_data.push(item);
                }
                var cy_chart = echarts.init(document.getElementById(div_id));
                option = {
                    series: [{
                        type: 'wordCloud',
                        size: ['100%', '100%'],
                        textRotation: [0, 45, -45, 90],
                        textPadding: 1,
                        autoSize: {
                            enable: true,
                            minSize: 40
                        },
                        data: show_data
                    }]
                };
                cy_chart.setOption(option);
            }


                function show_chart(div_id, data_text, data_x, data_y, y_name) {

                    var chart = echarts.init(document.getElementById(div_id));
                    var option = {
                        //title: {
                        //   text: data_text
                        //},
                        tooltip: {
                            trigger: 'axis'
                        },
                        //legend: {
                        //    data: [data_text]
                        //},
                        xAxis: [
                            {
                                type: 'category',
                                boundaryGap: false,
                                data: data_x
                            }
                        ],
                        yAxis: [
                            {
                                name: y_name,
                                type: 'value'
                            }
                        ],
                        series: [
                            {
                                name: data_text,
                                type: 'line',
                                stack: '总量',
                                label: {
                                    normal: {
                                        show: true,
                                        position: 'top'
                                    }
                                },
                                areaStyle: {normal: {}},
                                data: data_y
                            }
                        ]
                    };

                    chart.setOption(option);


                }


                function show_comments_data_list(comments_data_list) {

                    comments_data_list.sort(
                     function (d1, d2) {
                            if (d1.time.length == 0)
                                return 1;
                            if (d2.time.length == 0)
                                return -1;
                            str1 = d1.time.replace(/-/g, "/");
                            str2 = d2.time.replace(/-/g, "/");
                            var date1 = new Date(str1);
                            var date2 = new Date(str2);
                            var value = 1;
                            if (date1 < date2)
                                value = -1;
                            return value * -1;

                        }
                   );

                    var show_num = Math.min(comments_data_list.length,5);
                    for (var i = 0; i < show_num; ++i) {
                        $('#comments_div').append(
                                "<a class='list-group-item'  >"
                                + "<strong>"+comments_data_list[i].time +"</strong><br>"
                                  + comments_data_list[i].comment +
                                "</a>"
                        );
                    }

                }

            });

            function show_frequent_label(platform_name, frequent_label) {
                var comment_chart = echarts.init(document.getElementById('comment_div'));
                var comment_option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: "{b} : {d}%"
                    },
                    series: [
                        {
                            name: '访问来源',
                            type: 'pie',
                            radius: '60%',
                            center: ['50%', '50%'],
                            data: frequent_label,
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
                comment_chart.setOption(comment_option);
            }


        </script>


    </div>
    </div>


    <script src="{{ url_for("static",filename='js/echarts-all-2.2.7.js') }}"></script>
{% endblock %}            