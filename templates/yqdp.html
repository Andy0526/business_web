{% extends "layout.html" %}

{% block title %} 舆情大盘 {% endblock %}

{% block body %}
    <div class="container" style="margin-top: 70px">

        <div class="row col-md-offset">

            <!--年度舆情热度分析 开始 -->
            <div class="col-md-10 col-md-offset-1">
                <ol class="breadcrumb">
                    <li class="active">年度舆情热度分析</li>
                </ol>
                <div id="month_summary" style="width:90%;margin: 0 auto"></div>
                <script type="text/javascript">
                    var rate = 0.7;
                    $(document).ready(function () {
                        div_object = $("#month_summary");
                        div_object.height(Math.round(div_object.width() * 0.45))
                        show_month_summary();
                    });
                    function show_month_summary() {
                        var month_summary_chart = echarts.init(document.getElementById('month_summary'));
                        month_summary_option = {
                            tooltip: {
                                trigger: 'axis'
                            },
                            toolbox: {
                                feature: {
                                    dataView: {show: true, readOnly: false},
                                    magicType: {show: true, type: ['line', 'bar']},
                                    restore: {show: true},
                                    saveAsImage: {show: true}
                                }
                            },
                            legend: {
                                data: ['政策', '新闻', '用户评论']
                            },
                            xAxis: [
                                {
                                    type: 'category',
                                    data: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
                                }
                            ],
                            yAxis: [
                                {
                                    type: 'value',
                                    name: '文章数',
                                    min: 0,
                                    max: 1250,
                                    interval: 250,
                                    axisLabel: {
                                        formatter: '{value} 篇'
                                    }
                                },
                                {
                                    type: 'value',
                                    name: '评论数',
                                    min: 0,
                                    max: 35000,
                                    interval: 7000,
                                    axisLabel: {
                                        formatter: '{value} 条'
                                    }
                                }
                            ],
                            series: [
                                {
                                    name: '政策',
                                    type: 'bar',
                                    data: [20, 22, 35, 10, 14, 12, 31, 17, 11, 12, 15, 24]
                                },
                                {
                                    name: '新闻',
                                    type: 'bar',
                                    data: [467, 319, 472, 561, 597, 608, 799, 842, 903, 778, 1018, 1176]
                                },
                                {
                                    name: '用户评论',
                                    type: 'line',
                                    yAxisIndex: 1,
                                    data: [6968, 7817, 9918, 14039, 14264, 12357, 17655, 20388, 22736, 29731, 34460, 34222]
                                }
                            ]
                        };
                        month_summary_chart.setOption(month_summary_option);
                    }
                </script>

            </div>
            <!--年度舆情热度分析 结束 -->

            <!--网贷平台分布分析 开始 -->
            <div class="col-md-5 col-md-offset-1">
                <ol class="breadcrumb">
                    <li class="active">网贷平台分布分析</li>
                </ol>
                <div id="industry_areas" style="width:100%;margin: 0 auto"></div>
                <script src="{{ url_for("static",filename='js/china.js') }}"></script>
                <script type="text/javascript">
                    $(document).ready(function () {
                        div_object = $("#industry_areas");
                        div_object.height(Math.round(div_object.width() * rate))
                        industry_areas();
                    });
                    function industry_areas() {
                        var data_info = {
                            '广东': {
                                "成交量": "369.5亿元",
                                "运营平台": "461",
                                "问题平台": "241家",
                                "综合利率": "11.89%"
                            },
                            '北京': {
                                "成交量": "305.74亿元",
                                "运营平台": "213",
                                "问题平台": "87家",
                                "综合利率": "10.83%"
                            },
                            '上海': {
                                "成交量": "142.42亿元",
                                "运营平台": "213",
                                "问题平台": "116家",
                                "综合利率": "10.4%"
                            },
                            '浙江': {
                                "成交量": "137.42亿元",
                                "运营平台": "292",
                                "问题平台": "157家",
                                "综合利率": "11.44%"
                            },
                            '山东': {
                                "成交量": "43.6亿元",
                                "运营平台": "311",
                                "问题平台": "266家",
                                "综合利率": "16.5%"
                            },
                            '江苏': {
                                "成交量": "26.55亿元",
                                "运营平台": "127",
                                "问题平台": "84家",
                                "综合利率": "15.72%"
                            },
                            '四川': {
                                "成交量": "26.27亿元",
                                "运营平台": "83",
                                "问题平台": "45家",
                                "综合利率": "13.18%"
                            },
                            '湖北': {
                                "成交量": "12.31亿元",
                                "运营平台": "83",
                                "问题平台": "50家",
                                "综合利率": "16.31%"
                            },
                        };

                        var names = [];
                        for (var key in data_info) {
                            names.push(key)
                        }

                        var industry_areas_chart = echarts.init(document.getElementById('industry_areas'));
                        industry_areas_option = {
                            tooltip: {
                                trigger: 'item',
                                formatter: function (params) {
                                    return params.name + '<br>'
                                            + '运营平台: ' + data_info[params.name]['运营平台'] + '家<br>'
                                            + '成交量: ' + data_info[params.name]['成交量'] + '<br>'
                                            + '问题平台: ' + data_info[params.name]['问题平台'] + '<br>'
                                            + '综合利率: ' + data_info[params.name]['综合利率'] + '<br>'
                                }
                            },
                            dataRange: {
                                min: 0,
                                max: 500,
                                x: 'left',
                                y: 'bottom',
                                text: ['高', '低'],           // 文本，默认为数值文本
                                calculable: true
                            },
                            legend: {
                                orient: 'vertical',
                                left: 'left',
                                data: ['运营平台数量']
                            },
                            series: [
                                {
                                    name: '运营平台数量',
                                    type: 'map',
                                    mapType: 'china',
                                    roam: false,
                                    itemStyle: {
                                        normal: {label: {show: true}},
                                        emphasis: {label: {show: true}}
                                    },
                                    data: names.map(function (d) {
                                        return {name: d, value: data_info[d]['运营平台']}
                                    })
                                }
                            ]
                        };
                        industry_areas_chart.setOption(industry_areas_option);
                    }
                </script>

            </div>
            <!--网贷平台分布分析 结束 -->

            <!--投资借款人数状况分析 开始 -->
            <div class="col-md-5">
                <ol class="breadcrumb">
                    <li class="active">投资借款人数状况分析</li>
                </ol>
                <div id="industry_hot_people" style="width:100%;margin: 0 auto"></div>
                <script type="text/javascript">
                    $(document).ready(function () {
                        div_object = $("#industry_hot_people");
                        div_object.height(Math.round(div_object.width() * rate))
                        show_industry_hot_people();
                    });
                    function show_industry_hot_people() {
                        var industry_hot_people_chart = echarts.init(document.getElementById('industry_hot_people'));
                        industry_hot_people_option = {
                            tooltip: {
                                trigger: 'axis'
                            },
                            legend: {
                                data: ['借款人数', '投资人数']
                            },
                            toolbox: {
                                feature: {
                                    saveAsImage: {}
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: [
                                {
                                    type: 'category',
                                    boundaryGap: false,
                                    data: [
                                        '2015/1/1', '2015/2/1', '2015/3/1', '2015/4/1', '2015/5/1', '2015/6/1',
                                        '2015/7/1', '2015/8/1', '2015/9/1', '2015/10/1', '2015/11/1', '2015/12/1'
                                    ]
                                }
                            ],
                            yAxis: [
                                {
                                    name: '人数(万人)',
                                    type: 'value'
                                }
                            ],
                            series: [
                                {
                                    name: '借款人数',
                                    type: 'line',
                                    stack: '总量',
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'top'
                                        }
                                    },
                                    areaStyle: {normal: {}},
                                    data: [19.1, 16.18, 18.17, 22.69, 27.84, 33.04, 44.13, 54.94, 56.91, 58.09, 71.94, 78.49]
                                },
                                {
                                    name: '投资人数',
                                    type: 'line',
                                    stack: '总量',
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'top'
                                        }
                                    },
                                    areaStyle: {normal: {}},
                                    data: [88.22, 80.86, 96.16, 113, 126.79, 154.36, 179.31, 204.28, 240.41, 247.34, 300.62, 298.02]
                                }
                            ]
                        };
                        industry_hot_people_chart.setOption(industry_hot_people_option);
                    }
                </script>

            </div>
            <!--投资借款人数状况分析 结束 -->

            <!-- 投资借款金额状况分析 开始 -->
            <div class="col-md-5 col-md-offset-1">
                <ol class="breadcrumb">
                    <li class="active">投资借款金额状况分析</li>
                </ol>
                <div id="industry_hot_money" style="width:100%;margin: 0 auto"></div>
                <script type="text/javascript">
                    $(document).ready(function () {
                        div_object = $("#industry_hot_money");
                        div_object.height(Math.round(div_object.width() * rate))
                        show_industry_hot_money();
                    });
                    function show_industry_hot_money() {
                        var industry_hot_money_chart = echarts.init(document.getElementById('industry_hot_money'));
                        industry_hot_money_option = {
                            tooltip: {
                                trigger: 'axis'
                            },
                            legend: {
                                data: ['人均投资', '人均借款']
                            },
                            toolbox: {
                                feature: {
                                    saveAsImage: {}
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: [
                                {
                                    type: 'category',
                                    boundaryGap: false,
                                    data: [
                                        '2015/1/1', '2015/2/1', '2015/3/1', '2015/4/1', '2015/5/1', '2015/6/1',
                                        '2015/7/1', '2015/8/1', '2015/9/1', '2015/10/1', '2015/11/1', '2015/12/1'
                                    ]
                                }
                            ],
                            yAxis: [
                                {
                                    name: '金额(元)',
                                    type: 'value'
                                }
                            ],
                            series: [
                                {
                                    name: '人均投资',
                                    type: 'line',
                                    stack: '总量',
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'top'
                                        }
                                    },
                                    areaStyle: {normal: {}},
                                    data: [40559, 41446, 51227, 48801, 48081, 42729,
                                        46015, 47710, 47913, 48374, 44282, 44878]
                                },
                                {
                                    name: '人均借款',
                                    type: 'line',
                                    stack: '总量',
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'top'
                                        }
                                    },
                                    areaStyle: {normal: {}},
                                    data: [187340, 207132, 271106, 243037, 218973, 199649,
                                        186987, 177398, 202419, 205974, 185061, 170391]
                                }
                            ]
                        };
                        industry_hot_money_chart.setOption(industry_hot_money_option);
                    }
                </script>

            </div>
            <!-- 人均投资借款金额走势图 结束 -->

            <!-- 综合利率走势图 开始-->
            <div class="col-md-5">
                <ol class="breadcrumb">
                    <li class="active">综合利率分析</li>
                </ol>
                <div id="industry_interest" style="width:100%;margin: 0 auto"></div>
                <script type="text/javascript">
                    $(document).ready(function () {
                        div_object = $("#industry_interest");
                        div_object.height(Math.round(div_object.width() * rate))
                        show_industry_interest();
                    });
                    function show_industry_interest() {
                        var industry_interest_chart = echarts.init(document.getElementById('industry_interest'));
                        industry_interest_option = {
                            tooltip: {
                                trigger: 'axis'
                            },
                            legend: {
                                data: ['综合利率']
                            },
                            toolbox: {
                                feature: {
                                    saveAsImage: {}
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: [
                                {
                                    type: 'category',
                                    boundaryGap: false,
                                    data: [
                                        '2015/3/1', '2015/4/1', '2015/5/1', '2015/6/1', '2015/7/1', '2015/8/1', '2015/9/1', '2015/10/1', '2015/11/1', '2015/12/1', '2016/1/1', '2016/2/1'
                                    ]
                                }
                            ],
                            yAxis: [
                                {
                                    name: '百分比(%)',
                                    type: 'value'
                                }
                            ],
                            series: [
                                {
                                    name: '综合利率',
                                    type: 'line',
                                    stack: '总量',
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'top'
                                        }
                                    },
                                    areaStyle: {normal: {}},
                                    data: [15.02, 14.46, 14.57, 14.17, 13.58, 12.98, 12.63, 12.38, 12.25, 12.45, 12.18, 11.86]
                                }
                            ]
                        };
                        industry_interest_chart.setOption(industry_interest_option);
                    }
                </script>

            </div>
            <!-- 综合利率走势图 结束-->


            <div class="col-md-10 col-md-offset-1">
                <ol class="breadcrumb">
                    <li class="active">关注平台</li>
                </ol>
            </div>
            <div class="col-md-7 col-md-offset-1">
                <div><a class="list-group-item list-group-item-heading list-group-item-info">
                    <strong>友情提示 : </strong> 最多可关注三个，点击平台名称可以切换，点击 <span class='glyphicon glyphicon-minus'></span>
                    可删除，右侧输入框可以添加平台。
                </a></div>
                <br>
                <div id="seleced_platform_names"></div>
            </div>


            <div class="col-md-3" id="select_div">
                <div class="input-group">
                    <input id="input_name" type="text" class="form-control" onKeyUp="update_show_list()"
                           placeholder="请输入要关注的平台名称">
                        <span class="input-group-btn">
                             <button id="" class="btn btn-success" type="button" onclick="add_interested_platform()">
                                 添加
                             </button>
                        </span>
                </div>
                <br>

                <div id="platform_name_list" class="list-group">

                </div>

            </div>

            <script>
                // 列表相关 -----------------------------------------------
                var platform_name_list; // 全局的
                var last_str = "";
                // 列表点击事件
                function slecet_name(object) {
                    $("#input_name")[0].value = object.text;
                    update_show_list();
                }
                // 更新列表
                function update_show_list() {
                    var input_name = $("#input_name")[0].value;
                    // 字符串相同不更新列表
                    if (input_name == last_str)
                        return;
                    last_str = input_name;
                    // 更新列表
                    $("#platform_name_list").html("");
                    for (var i = 0; i < platform_name_list.length; ++i) {
                        platform_name = platform_name_list[i];
                        if (platform_name.indexOf(input_name) >= 0) {
                            $("#platform_name_list").append("<a class='list-group-item' onclick='slecet_name(this)'>" + platform_name + "</a>")
                        }
                    }
                }
                // 添加列表
                function add_interested_platform() {
                    if (seleced_platform_names_list.length >= 3) {
                        alert("最多只能添加三个！")
                        return;
                    }

                    var input_name = $("#input_name")[0].value;
                    // 检查输入
                    if (input_name.length == 0) {
                        alert("添加的平台名称不能为空！");
                        return;
                    }
                    // 是否存在
                    var is_existed = false;
                    for (var i = 0; i < platform_name_list.length; ++i) {
                        platform_name = platform_name_list[i];
                        if (platform_name == input_name) {
                            is_existed = true;
                            break;
                        }
                    }
                    if (!is_existed) {
                        alert("系统无该平台数据，请输入列表中的平台名称！");
                        return;
                    }

                    var index = seleced_platform_names_list.indexOf(input_name);
                    if (index < 0) {
                        seleced_platform_names_list.push(input_name);
                        show_name = input_name;
                        show_platform();
                    } else {
                        alert("已经存在！")
                    }
                }

                // 列表显示相关 ----------------------------------------------

                // 点击事件
                function btn_click(name) {
                    show_name = name;
                    show_platform();
                }

                // 刷新
                function show_platform() {
                    $("#seleced_platform_names").html("");
                    for (var i = 0; i < seleced_platform_names_list.length; ++i) {
                        platform_name = seleced_platform_names_list[i];
                        $("#seleced_platform_names").append(
                                "<button value=" + platform_name + " class='btn btn-lg btn-info' type='button' onclick='btn_click(this.value)'>" +
                                platform_name +
                                "</button>&nbsp;" +
                                "<button class='btn btn-lg btn-info' type='button'>" +
                                "<span title=" + platform_name + " class='glyphicon glyphicon-minus' onclick='remove_platform_name(this)'> " + "</span>" +
                                "</button>&nbsp;&nbsp;&nbsp;&nbsp;"
                        )
                    }
                    if (show_name != "") {
                        $("#seleced_platform_names").append("<br><br>")
                        show_paltform_info(show_name)
                    }
                }

                // 删除一个平台
                function remove_platform_name(object) {
                    var name = object.title;
                    var index = seleced_platform_names_list.indexOf(name);
                    seleced_platform_names_list.splice(index, 1)

                    if (seleced_platform_names_list.length == 0) {
                        show_name = ""
                        $("#seleced_platform_names").html("");
                    } else {
                        show_name = seleced_platform_names_list[0];
                        show_platform();
                    }
                }

                var seleced_platform_names_list = ['拍拍贷', '陆金所'];
                var show_name = '拍拍贷';

                $(document).ready(function () {
                    show_platform();
                    $.getJSON("/ptpx/platform_name_list", function (data) {
                        platform_name_list = data.platform_name_list;
                        for (var i = 0; i < platform_name_list.length; ++i) {
                            platform_name = platform_name_list[i];
                            $("#platform_name_list").append("<a class='list-group-item'  onclick='slecet_name(this)'>" + platform_name + "</a>")
                        }
                    });
                });

                function show_paltform_info(platform_name) {

                    $("#seleced_platform_names").append(
                            '<a id="chart_div_title" class="list-group-item list-group-item-info"> ' +
                            '<span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp'+platform_name+'的数据</a>' +
                            '<div id="chart_dropdown" class="dropdown"  style="border:1px solid lightgrey;border-top: none;border-bottom: none">' +
                             '<button class="btn btn-info dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true' +
                             'style="margin-left: 15px;margin-top: 15px;"> ' +
                             '<span id="show_chart_title"> 利率信息</span> ' +
                             '<span class="caret"></span> </button> ' +
                             '<ul class="dropdown-menu" aria-labelledby="dropdownMenu1"> ' +
                             '<li> <a onclick="show_chart(\'chart_div\', \'利率信息\', \'0\',\'x\',\'y1\', \'百分比(%)\')">利率信息</a> </li>' +
                             '<li> <a onclick="show_chart(\'chart_div\', \'成交量信息\', \'0\',\'x\',\'y2\', \'成交量(万)\')">成交量信息</a> </li>' +
                    '<li> <a onclick="show_chart(\'chart_div\', \'待还款信息\', \'1\',\'x\',\'y1\', \'代还款(万)\')">待还款信息</a> </li>' +
                    '<li> <a onclick="show_chart(\'chart_div\', \'资金净流入\', \'1\',\'x\',\'y2\', \'净流入资金(万)\')">资金净流入</a> </li> ' +
                             '<li> <a onclick=" show_chart(\'chart_div\', \'投资人数\',\'2\',\'x\', \'y1\', \'投资人数(人)\')">投资人数</a> </li> ' +
                             '<li> <a onclick="show_chart(\'chart_div\', \'借款人数\', \'2\',\'x\',\'y2\', \'借款人数(人)\')">借款人数</a> </li> </ul> </div> ' +
                            '<div id="chart_div" style="width:100%;margin: 0 auto;border:1px solid lightgrey;border-top: none"> </div>' +
                             '<div id="yq_div"> ' +
                            '<a class="list-group-item list-group-item-info list-group-item-heading"> ' +
                            '<span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp舆情关键词 </a> ' +
                            '<div id="yq_keyword" style="width:100%;border:1px solid lightgrey;border-top: none;"> </div>' +
                            '</div>' +
                             '<a  id ="comment_div_title"class="list-group-item list-group-item-info list-group-item-heading">' +
                            '<span class="glyphicon glyphicon-hand-right"></span>&nbsp&nbsp' + platform_name + '用户评价 </a>' +
                            '<div id="comment_div" style="width:100%;margin: 0 auto;border:1px solid lightgrey;border-top: none;">' +
                            '</div>'  )

                div_object = $("#chart_div");
                        div_object.height(Math.round(div_object.width() * 0.6))

                 div_object = $("#yq_keyword");
                        div_object.height(Math.round(div_object.width() * 0.382))

                    div_object = $("#comment_div");
                        div_object.height(Math.round(div_object.width() * 0.6))

                    // 显示
                    $.getJSON("/detail/platform/" + platform_name + "/info", function (data) {


                        // 初始化和配置图表数据
                         init_and_show_chart(data);

                        // 显示热点词云
                        show_hot_word(data);

                         var frequent_label = data['frequent_label']
                        if (frequent_label.length > 0) {
                            show_frequent_label(platform_name, frequent_label)
                            // show_hot_word(frequent_label,'pl_keyword')
                        } else {
                            $('#comment_div_title').hide();
                            $('#comment_div').hide();
                        }

                    });
                }


                    // 显示热点词汇
        function createRandomItemStyle() {
            var base = 240;
            return {
                normal: {
                    color: 'rgb(' + [
                        Math.round(Math.random() * base),
                        Math.round(Math.random() * base),
                        Math.round(Math.random() * base)
                    ].join(',') + ')'
                }
            };
        }
        function show_hot_word(data) {

            if (data.keyword.length == 0) {
                $('#yq_div').hide();
                return;
            }

            var word_data = data.keyword;
            var div_id = 'yq_keyword';

            var size = 50;
            var show_data = [];
            for (var i = 0; i < word_data.length; ++i) {
                var word = word_data[i];
                if (size > 40)
                    size -= 4;
                else if (size > 24)
                    size -= 2;
                else if (size > 8)
                    size -= 1;

                var item = {};
                item['name'] = word['name'];
                item['value'] = size;
                item['itemStyle'] = createRandomItemStyle();
                show_data.push(item);
            }
            var cy_chart = echarts.init(document.getElementById(div_id));
            option = {
                series: [{
                    type: 'wordCloud',
                    size: ['100%', '100%'],
                    textRotation: [0, 45, -45, 90],
                    textPadding: 1,
                    autoSize: {
                        enable: true,
                        minSize: 40
                    },
                    data: show_data
                }]
            };
            cy_chart.setOption(option);
        }
                   // 初始化和配置图表数据
        var data_chart_json;
        function init_and_show_chart(data) {
            if (data['chart_json']['0'] == null) {
                $("#chart_div_title").hide();
                $("#chart_dropdown").hide();
                $("#chart_div").hide();
            } else {
                data_chart_json = data['chart_json'];
                show_chart('chart_div', '利率信息', '0', 'x', 'y1', '百分比(%)');
            }
        }
        // 动态显示图表
        function show_chart(div_id, data_text, index, x_index, y_index, y_name) {

            $("#show_chart_title").text(data_text);

            data_x = data_chart_json[index][x_index];
            data_y = data_chart_json[index][y_index];

            var chart = echarts.init(document.getElementById(div_id));
            var option = {
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: [
                    {
                        type: 'category',
                        boundaryGap: false,
                        data: data_x
                    }
                ],
                yAxis: [
                    {
                        name: y_name,
                        type: 'value'
                    }
                ],
                series: [
                    {
                        name: data_text,
                        type: 'line',
                        stack: '总量',
                        label: {
                            normal: {
                                show: true,
                                position: 'top'
                            }
                        },
                        areaStyle: {normal: {}},
                        data: data_y
                    }
                ]
            };

            chart.setOption(option);
        }

                function show_frequent_label(platform_name, frequent_label) {
                    var comment_chart = echarts.init(document.getElementById('comment_div'));
                    var comment_option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: "{b} : {d}%"
                        },
                        series: [
                            {
                                name: '访问来源',
                                type: 'pie',
                                radius: '60%',
                                center: ['50%', '50%'],
                                data: frequent_label,
                                itemStyle: {
                                    emphasis: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }
                        ]
                    };
                    comment_chart.setOption(comment_option);
                }

            </script>

        </div>

    </div>

    <script src="{{ url_for("static",filename='js/echarts-all-2.2.7.js') }}"></script>

{% endblock %}